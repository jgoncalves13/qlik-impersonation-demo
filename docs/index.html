<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ejemplo de Integración con Qlik-Embed</title>
    <script src="https://cdn.qlik-dev.com/qlik-embed.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #qlik-app-container { width: 100%; height: 900px; }
        .mensaje { margin-top: 20px; font-weight: bold; }
        .mensaje.exito { color: green; }
        .mensaje.error { color: red; }
    </style>
</head>
<body>

    <h1>Integración de Qlik Sense con Qlik-Embed</h1>
    <p>Haz clic en el botón para obtener un token y cargar la aplicación de Qlik.</p>
    
    <button onclick="embedQlikApp()">Obtener Token y Cargar App</button>

    <div id="status-message" class="mensaje"></div>

    <div id="qlik-app-container"></div>

    <script>
        // Función para obtener el token del servidor backend
        async function fetchImpersonationToken() {
            try {
                // Esta es la ruta a tu servidor local de Node.js que genera el token
                const response = await fetch('/api/get-impersonation-token');
                if (!response.ok) {
                    throw new Error('No se pudo obtener el token del servidor.');
                }
                const data = await response.json();
                return data.access_token;
            } catch (error) {
                console.error('Error al obtener el token:', error);
                return null;
            }
        }

        // Función principal para incrustar la aplicación de Qlik
        async function embedQlikApp() {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = 'Obteniendo token...';
            statusMessage.className = 'mensaje';

            const accessToken = await fetchImpersonationToken();

            if (!accessToken) {
                statusMessage.textContent = 'Error: No se pudo obtener el token de acceso.';
                statusMessage.className = 'mensaje error';
                return;
            }

            statusMessage.textContent = 'Token obtenido. Incrustando aplicación...';
            statusMessage.className = 'mensaje exito';

            const appContainer = document.getElementById('qlik-app-container');
            
            // Configuración para qlik-embed
            const embedConfig = {
                host: 'keyruspt.eu.qlikcloud.com',
                appId: '2600467e-7e6c-4c36-9fb4-2139caa1cb4d',
                sheetId: 'pwn', // Opcional: ID de una hoja específica
                embed: appContainer,
                oauth2: {
                    accessToken: accessToken,
                },
                // El webIntegrationId es necesario para que Qlik-Embed funcione
                webIntegrationId: 'F5lgGsalXWNob9SEj1n-PuH-l93y9Ojk',
                // Otros parámetros que puedes necesitar
                theme: 'horizon',
                selections: 'current',
            };

            // Crea una nueva instancia de QlikEmbed
            const qlikEmbed = new QlikEmbed();

            // Lanza el proceso de incrustación
            qlikEmbed.embed(embedConfig);

            // Escucha eventos para saber si la incrustación fue exitosa o falló
            qlikEmbed.on('embedded', () => {
                statusMessage.textContent = '¡Aplicación incrustada correctamente!';
            });

            qlikEmbed.on('error', (error) => {
                statusMessage.textContent = `Error al incrustar: ${error.message}`;
                statusMessage.className = 'mensaje error';
            });
        }
    </script>
</body>
</html>
